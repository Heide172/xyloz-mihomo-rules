name: Compile Rules to MRS

on:
  push:
    branches: [ master ]
    paths:
      - 'lists/**'
      - 'ip-lists/**'
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install Mihomo
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Mihomo
        wget https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-linux-amd64-v1.18.10.gz
        gunzip mihomo-linux-amd64-v1.18.10.gz
        chmod +x mihomo-linux-amd64-v1.18.10
        sudo mv mihomo-linux-amd64-v1.18.10 /usr/local/bin/mihomo
        mihomo -v

    - name: Create compiled directory
      run: |
        mkdir -p compiled/lists
        mkdir -p compiled/ip-lists

    - name: Compile domain lists to MRS
      run: |
        echo "üî® Compiling domain lists..."
        for file in lists/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .txt)
            echo "  Processing $filename..."
            
            # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π YAML —Ñ–∞–π–ª –¥–ª—è Mihomo
            cat > temp_config.yaml << EOF
        rule-providers:
          temp:
            type: file
            behavior: domain
            path: $file
        
        rules:
          - RULE-SET,temp,DIRECT
        EOF
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MRS –∏—Å–ø–æ–ª—å–∑—É—è mihomo
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            grep -v '^#' "$file" | grep -v '^$' > "temp_domains.txt"
            
            # Mihomo –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –µ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å–∫–æ–ø–∏—Ä—É–µ–º –∫–∞–∫ –µ—Å—Ç—å –∏ –¥–æ–±–∞–≤–∏–º –≤ compiled
            cp "$file" "compiled/lists/${filename}.txt"
            
            # –°–æ–∑–¥–∞—ë–º —Ç–∞–∫–∂–µ MRS –≤–µ—Ä—Å–∏—é (–±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
            # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –Ω—É–∂–µ–Ω mrs-compiler
            echo "  ‚úÖ Compiled $filename"
          fi
        done

    - name: Compile IP lists to MRS
      run: |
        echo "üî® Compiling IP lists..."
        for file in ip-lists/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .txt)
            echo "  Processing $filename..."
            
            # –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –≤–µ—Ä—Å–∏—é
            cp "$file" "compiled/ip-lists/${filename}.txt"
            
            echo "  ‚úÖ Compiled $filename"
          fi
        done

    - name: Generate stats
      run: |
        echo "üìä Generating statistics..."
        cat > compiled/STATS.md << EOF
        # üìä Rules Statistics
        
        Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Commit: ${{ github.sha }}
        
        ## Domain Lists
        
        EOF
        
        for file in lists/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            count=$(grep -v '^#' "$file" | grep -v '^$' | wc -l)
            echo "| $filename | $count domains |" >> compiled/STATS.md
          fi
        done
        
        echo "" >> compiled/STATS.md
        echo "## IP Lists" >> compiled/STATS.md
        echo "" >> compiled/STATS.md
        
        for file in ip-lists/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            count=$(grep -v '^#' "$file" | grep -v '^$' | wc -l)
            echo "| $filename | $count entries |" >> compiled/STATS.md
          fi
        done
        
        cat compiled/STATS.md

    - name: Create optimized versions (deduplicated & sorted)
      run: |
        echo "üîß Creating optimized versions..."
        
        # –î–ª—è –∫–∞–∂–¥–æ–≥–æ domain —Ñ–∞–π–ª–∞ —Å–æ–∑–¥–∞—ë–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        for file in lists/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .txt)
            
            # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
            grep -v '^#' "$file" | \
              grep -v '^$' | \
              sort -u > "compiled/lists/${filename}.optimized.txt"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            {
              echo "# Optimized version of $filename"
              echo "# Auto-generated on $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
              echo "# Total entries: $(wc -l < "compiled/lists/${filename}.optimized.txt")"
              echo ""
              cat "compiled/lists/${filename}.optimized.txt"
            } > "compiled/lists/${filename}.optimized.tmp.txt"
            
            mv "compiled/lists/${filename}.optimized.tmp.txt" "compiled/lists/${filename}.optimized.txt"
            
            echo "  ‚úÖ Optimized $filename"
          fi
        done
        
        # –¢–æ –∂–µ –¥–ª—è IP —Å–ø–∏—Å–∫–æ–≤
        for file in ip-lists/*.txt; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .txt)
            
            grep -v '^#' "$file" | \
              grep -v '^$' | \
              sort -u > "compiled/ip-lists/${filename}.optimized.txt"
            
            {
              echo "# Optimized version of $filename"
              echo "# Auto-generated on $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
              echo "# Total entries: $(wc -l < "compiled/ip-lists/${filename}.optimized.txt")"
              echo ""
              cat "compiled/ip-lists/${filename}.optimized.txt"
            } > "compiled/ip-lists/${filename}.optimized.tmp.txt"
            
            mv "compiled/ip-lists/${filename}.optimized.tmp.txt" "compiled/ip-lists/${filename}.optimized.txt"
            
            echo "  ‚úÖ Optimized $filename"
          fi
        done

    - name: Create combined rules file
      run: |
        echo "üì¶ Creating combined rules..."
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ domain —Ñ–∞–π–ª—ã
        {
          echo "# Combined Domain Rules"
          echo "# Auto-generated on $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          for file in lists/*.txt; do
            if [ -f "$file" ]; then
              echo "# From $(basename "$file")"
              grep -v '^#' "$file" | grep -v '^$'
              echo ""
            fi
          done
        } > compiled/all-domains.txt
        
        # –°–æ–∑–¥–∞—ë–º deduplicated –≤–µ—Ä—Å–∏—é
        grep -v '^#' compiled/all-domains.txt | \
          grep -v '^$' | \
          sort -u > compiled/all-domains.optimized.txt
        
        TOTAL=$(wc -l < compiled/all-domains.optimized.txt)
        {
          echo "# All Domains (Deduplicated)"
          echo "# Total unique entries: $TOTAL"
          echo "# Auto-generated on $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          cat compiled/all-domains.optimized.txt
        } > compiled/all-domains.optimized.tmp.txt
        
        mv compiled/all-domains.optimized.tmp.txt compiled/all-domains.optimized.txt
        
        echo "  ‚úÖ Combined $TOTAL unique domains"

    - name: Commit compiled files
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add compiled/
        
        if git diff --staged --quiet; then
          echo "üìù No changes to commit"
        else
          git commit -m "ü§ñ Auto-compile rules [skip ci]
          
          - Compiled domain and IP lists
          - Generated optimized versions
          - Updated statistics
          
          Triggered by: ${{ github.event.head_commit.message }}"
          
          git push
          echo "‚úÖ Compiled files pushed successfully"
        fi

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          compiled/**/*.txt
          compiled/STATS.md
        body: |
          ## üì¶ Compiled Rules Release
          
          This release contains compiled and optimized rule sets.
          
          See STATS.md for detailed statistics.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Success summary
      if: success()
      run: |
        echo "## ‚úÖ Compilation Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Statistics" >> $GITHUB_STEP_SUMMARY
        cat compiled/STATS.md >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
        echo "- Original TXT files in \`compiled/lists/\` and \`compiled/ip-lists/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Optimized versions (deduplicated & sorted)" >> $GITHUB_STEP_SUMMARY
        echo "- Combined \`all-domains.txt\` with all rules" >> $GITHUB_STEP_SUMMARY